#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <dbus/dbus.h>
#include <unistd.h>
#include <gio/gio.h>
#include <glib/gprintf.h>
#include <gio/gdbusconnection.h>
#include <dbus/dbus-glib-lowlevel.h>
#include <pthread.h>

#define g_dbus_send g_dbus_connection_send_message_with_reply_sync

char *action_id;
char *cookie;
int32_t pid = 0;

int call_register() {
    // Reference : polkit_authority_register_authentication_agent
    // https://github.dev/wingo/polkit/blob/master/src/polkit/polkitauthority.c#L1053
    printf("[*] Registering agent to polkit ...\n");
 
    const gchar *object_path = "/org/freedesktop/PolicyKit1/AuthenticationAgent";
    pid = getpid();

    GDBusConnection *bus;
    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GDBusMessage *request;
    GDBusMessage *reply;
    GVariantBuilder session;

    bus = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);
    request = g_dbus_message_new_method_call("org.freedesktop.PolicyKit1",
                                             "/org/freedesktop/PolicyKit1/Authority",
                                             "org.freedesktop.PolicyKit1.Authority",
                                             "RegisterAuthenticationAgent");

    g_variant_builder_init(&session, G_VARIANT_TYPE("a{sv}"));
    g_variant_builder_add(&session, "{sv}", "pid", g_variant_new_uint32(pid));
    g_variant_builder_add(&session, "{sv}", "start-time", g_variant_new_uint64(0));
    g_dbus_message_set_body(request, g_variant_new("((sa{sv})ss)", "unix-process", &session, "C", object_path));

    reply = g_dbus_send(bus, request, G_DBUS_SEND_MESSAGE_FLAGS_NONE, -1, NULL, NULL, NULL);
    g_object_unref(reply);
    g_variant_builder_clear(&session);
    printf("[*] polkit agent registered for %d\n", pid);

    return 0;
}

// DBusHandlerResult server_message_handler(DBusConnection *conn, DBusMessage *message, void *data);
// const DBusObjectPathVTable server_vtable = {
// 	.message_function = server_message_handler
// };


void *kill_myself(){
    int pid = getpid();
    sleep(1);
    kill(pid, SIGKILL);

    return 0;
}

int server_handle_authentication_agent_response2(char *cookie, GVariantIter *identities )
{
    //https://github.dev/wingo/polkit/blob/master/src/polkitbackend/polkitbackendauthority.c#L1065
    pthread_t t;
    GDBusConnection *connetion;

    GVariantBuilder identity;
    GVariant *identity_data;

    GVariantIter *identity_from_remote;
    gchar *key;
    gchar *idtype;
    GVariant *value;
    guint32 uid;

    g_variant_iter_loop(identities, "(sa{sv})", &idtype, &identity_from_remote);
    g_variant_iter_loop(identity_from_remote, "{sv}", &key, &value);
    g_variant_get(value, "u", &uid);

    printf("[*] Remote identity %s: %d\n", key, uid);

    g_variant_builder_init (&identity, G_VARIANT_TYPE("(sa{sv})"));
    g_variant_builder_add (&identity, "s", "unix-user");
    g_variant_builder_open (&identity, G_VARIANT_TYPE("a{sv}"));
    {
        g_variant_builder_open (&identity, G_VARIANT_TYPE("{sv}"));
        g_variant_builder_add (&identity, "s", "uid");
	g_variant_builder_add (&identity, "v", g_variant_new_uint32(uid));
        g_variant_builder_close (&identity);
    }
    g_variant_builder_close (&identity);
    identity_data = g_variant_builder_end(&identity);

    connetion = g_bus_get_sync(G_BUS_TYPE_SYSTEM, NULL, NULL);
    pthread_create(&t, NULL, &kill_myself, NULL);

    // put it in a new thread?
    g_dbus_connection_call(
        connetion, 
        "org.freedesktop.PolicyKit1",
        "/org/freedesktop/PolicyKit1/Authority",
        "org.freedesktop.PolicyKit1.Authority",
        "AuthenticationAgentResponse2",
        g_variant_new("(u&s@(sa{sv}))", getuid(), cookie, identity_data),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL,
        NULL
        );

    return 0;
}


static void
auth_agent_handle_begin_authentication (
                                         GVariant               *parameters,
                                         GDBusMethodInvocation  *invocation)
{
    gchar *actionid;
    gchar *message;
    gchar *icon;
    gchar *cookie;
    GVariantIter *details;
    GVariantIter *identities;

    g_variant_get(parameters, "(sssa{ss}sa(sa{sv}))",
                  &actionid,
                  &message,
                  &icon,
                  &details,
                  &cookie,
                  &identities);

    printf("[*] Received authentication for action '%s' ...\n", actionid);
    server_handle_authentication_agent_response2(cookie, identities);

}




static void auth_agent_handle_method_call (GDBusConnection        *connection,
                               const gchar            *sender,
                               const gchar            *object_path,
                               const gchar            *interface_name,
                               const gchar            *method_name,
                               GVariant               *parameters,
                               GDBusMethodInvocation  *invocation,
                               gpointer                user_data)
{
    if (g_strcmp0 (method_name, "BeginAuthentication") == 0){
        auth_agent_handle_begin_authentication ( parameters, invocation);
    }


    // return 0;
    return ;
}

static const GDBusInterfaceVTable auth_agent_vtable =
{
  auth_agent_handle_method_call,
  NULL, /* _handle_get_property */
  NULL  /* _handle_set_property */
};


static const char *authority_dbus_spec =
  "<node>"
  "  <interface name='org.freedesktop.PolicyKit1.AuthenticationAgent'>"
  "    <method name='BeginAuthentication'>"
  "      <arg type='s' name='action_id' direction='in'/>"
  "      <arg type='s' name='message' direction='in'/>"
  "      <arg type='s' name='icon_name' direction='in'/>"
  "      <arg type='a{ss}' name='details' direction='in'/>"
  "      <arg type='s' name='cookie' direction='in'/>"
  "      <arg type='a(sa{sv})' name='identities' direction='in'/>"
  "    </method>"
  "    <method name='CancelAuthentication'>"
  "      <arg type='s' name='cookie' direction='in'/>"
  "    </method>"
  "  </interface>"
  "</node>";


int PolkitAuthenticationAgent(){
    // Reference ï¼šhttps://github.dev/wingo/polkit/blob/master/src/examples/cancel.c#L142
    GMainLoop *loop;
    GDBusConnection *conn;
    GDBusInterfaceInfo *ifaceinfo;
    GDBusNodeInfo *nodeinfo;
    GError *dbus_error = NULL;
    conn = g_bus_get_sync(G_BUS_TYPE_SYSTEM, NULL, NULL);

    nodeinfo = g_dbus_node_info_new_for_xml (authority_dbus_spec, &dbus_error);
    if (nodeinfo == NULL)
    {
        fprintf(stderr, "some error %s\n", dbus_error->message);
    }

    ifaceinfo = g_dbus_node_info_lookup_interface (nodeinfo, "org.freedesktop.PolicyKit1.AuthenticationAgent");
    // https://cs.github.com/dylanmccall/rhythmbox-songinfo-context-menu/blob/cd37a61174863c56f4b12f9d1d5cf4573002d956/rhythmdb/rhythmdb-dbus.c#L39
    g_dbus_connection_register_object(conn, 
        "/org/freedesktop/PolicyKit1/AuthenticationAgent", 
        ifaceinfo,
        &auth_agent_vtable,
        NULL,
        NULL,
        &dbus_error);
    
    
    call_register();

    loop = g_main_loop_new(NULL, FALSE);
    g_main_loop_run(loop);
    printf("[*] D-Bus message loop new running ...\n");


    return 0;
}
